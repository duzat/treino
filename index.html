<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub-login</title>
  <style>
    :root{--bg1:#0a0f22;--bg2:#0a0f18;--glass:rgba(255,255,255,.08);--muted:#a8b3d6;--text:#eef2ff;--acc1:#7c9cff;--acc2:#65f7c1;--ok:#7ef19a;--danger:#ff6b6b;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
    body{margin:0;font-family:Poppins,system-ui;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    header{padding:12px 20px;background:rgba(255,255,255,.05);backdrop-filter:blur(10px);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ffffff14}
    .btn{border:0;padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,#232f63,#27406f);color:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(135deg,#2a4cff,#00ffc3)}
    .btn.danger{background:linear-gradient(135deg,#7a2c2c,#ff5252)}
    .btn.warn{background:linear-gradient(135deg,#ffb700,#ff9100);color:#1a1500}
    .card{background:rgba(255,255,255,.08);border-radius:var(--radius);padding:24px;max-width:420px;margin:auto;box-shadow:var(--shadow)}
    .hidden{display:none}
    input,select{width:100%;background:#0b1129;border:1px solid #ffffff1f;color:#fff;border-radius:10px;padding:10px;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1)}
    th{background:rgba(255,255,255,.1)}
    main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
  </style>
</head>
<body>
<header>
  <h2>üèãÔ∏è Calistenia Tracker</h2>
  <div>
    <button id="btn-admin" class="btn warn hidden">Admin</button>
    <button id="btn-logout" class="btn danger hidden">Sair</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <section id="login" class="card">
    <h3>Entrar</h3>
    <input id="login-user" placeholder="Usu√°rio" />
    <input id="login-pass" type="password" placeholder="Senha" />
    <button id="btn-login" class="btn primary" style="margin-top:10px">Entrar</button>
    <p id="login-msg"></p>
  </section>

  <!-- APP -->
  <section id="app" class="hidden card">
    <h3 id="today"></h3>
    <p id="check-status">Carregando‚Ä¶</p>
    <button id="btn-checkin" class="btn primary">Fazer Check-in</button>
    <table id="history-table">
      <thead><tr><th>Data</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ADMIN -->
  <section id="admin" class="hidden card">
    <h3>Painel Admin</h3>
    <table id="admin-table">
      <thead><tr><th>Usu√°rio</th><th>Data</th></tr></thead>
      <tbody></tbody>
    </table>
    <hr>
    <h4>Gerenciar usu√°rios</h4>
    <input id="u-user" placeholder="Usu√°rio" />
    <input id="u-pass" placeholder="Senha" />
    <select id="u-admin"><option value="false">Usu√°rio</option><option value="true">Administrador</option></select>
    <button id="u-save" class="btn primary" style="margin-top:8px">Salvar</button>
    <button id="u-del" class="btn danger" style="margin-top:4px">Excluir</button>
    <p id="u-msg"></p>
    <button id="admin-close" class="btn" style="margin-top:8px">Fechar</button>
  </section>
</main>

<script>
const SCRIPT_URL = 'COLE_AQUI_SUA_URL_DO_APPS_SCRIPT'; // ex: https://script.google.com/macros/s/AKfycbyEXEMPLO/exec
let SESSION = null;

function $(id){return document.getElementById(id)}

function today(){
  const now=new Date();
  const d=now.toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});
  return {label:d, iso:now.toISOString().slice(0,10)};
}

async function api(body){
  const headers={'Content-Type':'application/json'};
  if(SESSION?.token) headers['Authorization']='Bearer '+SESSION.token;
  const r=await fetch(SCRIPT_URL,{method:'POST',headers,body:JSON.stringify(body)});
  const t=await r.text();try{return JSON.parse(t);}catch{return {raw:t}};
}

$('btn-login').onclick=async()=>{
  const user=$('login-user').value.trim();
  const pass=$('login-pass').value;
  $('login-msg').textContent='Entrando...';
  const r=await api({action:'login',user,pass});
  if(r.error){$('login-msg').textContent='Erro: '+r.error;return;}
  SESSION=r;
  localStorage.setItem('sess',JSON.stringify(r));
  $('login').classList.add('hidden');
  $('app').classList.remove('hidden');
  $('btn-logout').classList.remove('hidden');
  if(r.isAdmin)$('btn-admin').classList.remove('hidden');
  $('today').textContent=today().label;
  loadStatus();
};

async function loadStatus(){
  const r=await api({action:'status',date:today().iso});
  if(r.checked){
    $('check-status').textContent='‚úÖ Check-in j√° feito hoje';
    $('btn-checkin').disabled=true;
  }else{
    $('check-status').textContent='Voc√™ ainda n√£o fez check-in hoje.';
    $('btn-checkin').disabled=false;
  }
  loadHistory();
}

$('btn-checkin').onclick=async()=>{
  const r=await api({action:'checkin',date:today().iso});
  $('check-status').textContent='‚úÖ Check-in registrado!';
  $('btn-checkin').disabled=true;
  loadHistory();
};

async function loadHistory(){
  const r=await api({action:'history'});
  const tb=$('#history-table tbody');tb.innerHTML='';
  (r.data||[]).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${x.date}</td><td>${x.status}</td>`;
    tb.appendChild(tr);
  });
}

$('btn-logout').onclick=()=>{
  SESSION=null;localStorage.removeItem('sess');
  location.reload();
};

$('btn-admin').onclick=async()=>{
  $('app').classList.add('hidden');
  $('admin').classList.remove('hidden');
  const r=await api({action:'admin_all'});
  const tb=$('#admin-table tbody');tb.innerHTML='';
  (r.data||[]).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${x.user}</td><td>${x.date}</td>`;
    tb.appendChild(tr);
  });
};

$('admin-close').onclick=()=>{$('admin').classList.add('hidden');$('app').classList.remove('hidden');};

$('u-save').onclick=async()=>{
  const user=$('u-user').value.trim();
  const pass=$('u-pass').value.trim();
  const isAdmin=$('u-admin').value==='true';
  if(!user||!pass)return $('u-msg').textContent='Preencha os campos!';
  await api({action:'user_upsert',user,pass,isAdmin});
  $('u-msg').textContent='Usu√°rio salvo!';
};

$('u-del').onclick=async()=>{
  const user=$('u-user').value.trim();
  if(!user)return $('u-msg').textContent='Informe o usu√°rio!';
  await api({action:'user_delete',user});
  $('u-msg').textContent='Usu√°rio exclu√≠do!';
};

// auto login
(function(){
  const s=localStorage.getItem('sess');
  if(s){SESSION=JSON.parse(s);$('login').classList.add('hidden');$('app').classList.remove('hidden');$('btn-logout').classList.remove('hidden');if(SESSION.isAdmin)$('btn-admin').classList.remove('hidden');$('today').textContent=today().label;loadStatus();}
})();
</script>
  
const SHEET_ID = '11BJ3pzCnOzSMiAuKeFs_Ll9gASZ5DVGibgMLOYjMzGc';
const SH_USERS = 'usuarios';
const SH_CHECK = 'checkins';
const SH_SESS = 'sessions';

function doPost(e){return handle_(e);}
function handle_(e){
  try{
    const b=JSON.parse(e.postData.contents||'{}');
    const a=b.action;
    if(a==='login')return login_(b);
    const t=getAuth(e);const s=verSess(t);
    if(!s)return j_({error:'sess√£o inv√°lida'},401);
    if(a==='status')return j_({checked:hasChk(s.user,b.date)});
    if(a==='checkin'){if(hasChk(s.user,b.date))return j_({ok:true});addChk(s,b.date);return j_({ok:true});}
    if(a==='history')return j_({data:getHist(s.user)});
    if(a==='admin_all'){if(!s.isAdmin)return j_({error:'denied'},403);return j_({data:getAll()});}
    if(a==='user_upsert'){if(!s.isAdmin)return j_({error:'denied'},403);usrUp(b);return j_({ok:true});}
    if(a==='user_delete'){if(!s.isAdmin)return j_({error:'denied'},403);usrDel(b.user);return j_({ok:true});}
  }catch(err){return j_({error:String(err)},500);}
}

function login_(b){const {user,pass}=b;const u=fndU(user);if(!u||u.password!==pass)return j_({error:'login incorreto'},401);const t=Utilities.getUuid();savSess(t,user,u.isAdmin);return j_({token:t,user,isAdmin:u.isAdmin});}
function fndU(u){const sh=o(SH_USERS);boot(sh);const v=sh.getDataRange().getValues();for(let i=1;i<v.length;i++){if(v[i][0]===u)return{user:v[i][0],password:v[i][1],isAdmin:v[i][2]==true||String(v[i][2]).toLowerCase()==='true'};}return null;}
function usrUp(b){const sh=o(SH_USERS);boot(sh);const v=sh.getDataRange().getValues();for(let i=1;i<v.length;i++){if(v[i][0]===b.user){sh.getRange(i+1,2).setValue(b.pass);sh.getRange(i+1,3).setValue(!!b.isAdmin);return;}}sh.appendRow([b.user,b.pass,!!b.isAdmin]);}
function usrDel(u){const sh=o(SH_USERS);const v=sh.getDataRange().getValues();for(let i=1;i<v.length;i++){if(v[i][0]===u){sh.deleteRow(i+1);return;}}}
function boot(sh){if(sh.getLastRow()==0){sh.appendRow(['user','password','isAdmin']);sh.appendRow(['admin','1234',true]);}}
function savSess(t,u,a){const sh=o(SH_SESS);if(sh.getLastRow()==0)sh.appendRow(['token','user','exp','isAdmin']);sh.appendRow([t,u,new Date(Date.now()+6048e5),!!a]);}
function verSess(t){if(!t)return null;const sh=o(SH_SESS);const v=sh.getDataRange().getValues();for(let i=1;i<v.length;i++){if(v[i][0]===t&&new Date(v[i][2])>new Date())return{user:v[i][1],isAdmin:v[i][3]==true||String(v[i][3]).toLowerCase()==='true'};}return null;}
function hasChk(u,d){const sh=o(SH_CHECK);const v=sh.getDataRange().getValues();for(let i=1;i<v.length;i++){if(v[i][0]===u&&v[i][1]===d)return true;}return false;}
function addChk(s,d){const sh=o(SH_CHECK);if(sh.getLastRow()==0)sh.appendRow(['user','date','at']);sh.appendRow([s.user,d,new Date()]);}
function getHist(u){const sh=o(SH_CHECK);const v=sh.getDataRange().getValues();const r=[];for(let i=1;i<v.length;i++){if(v[i][0]===u)r.push({date:v[i][1],status:'‚úîÔ∏è'});}return r;}
function getAll(){const sh=o(SH_CHECK);const v=sh.getDataRange().getValues();const r=[];for(let i=1;i<v.length;i++){r.push({user:v[i][0],date:v[i][1]});}return r;}
function getAuth(e){const h=e.headers||{};const a=h['Authorization']||h['authorization']||'';return a.startsWith('Bearer ')?a.substring(7):'';}
function o(n){const ss=SpreadsheetApp.openById(SHEET_ID);return ss.getSheetByName(n)||ss.insertSheet(n);}
function j_(o,c){const t=ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);if(c)t.setStatusCode(c);return t;}

</body>
</html>
